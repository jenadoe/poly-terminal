name: 2. Distribute & Commit

on:
  workflow_run:
    workflows: ["1. Calculate & Analyze"]
    types:
      - completed

jobs:
  distribute:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Download Data
        uses: actions/download-artifact@v4
        with:
          name: nexus-data
          path: temp_data
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Private Brain
        uses: actions/checkout@v4
        with:
          repository: jenadoe/poly-core
          token: ${{ secrets.TOKEN1 }}
          path: private-brain

      - name: Push Assets to Private
        run: |
          # 1. [ì§„ë‹¨] ë„ëŒ€ì²´ temp_dataì— ë­ê°€ ë“¤ì–´ì™”ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸í•˜ì
          echo "ğŸ” [DEBUG] Listing files in temp_data:"
          ls -R temp_data
          
          cd private-brain
          
          # í´ë” ìƒì„±
          mkdir -p data_output/archive
          mkdir -p data_output/api/v1/events
          mkdir -p data_output/audit_logs
          mkdir -p data_output/completed_events
          
          # 2. [ê°•ì œ ë³µì‚¬] íŒŒì¼ì´ ìˆë“  ì—†ë“  ë®ì–´ì“°ê¸° ì‹œë„ (force)
          # active_events.json (ì‹ ê·œ ì´ë¦„) í™•ì¸ í•„ìˆ˜
          if [ -f ../temp_data/active_events.json ]; then
            echo "âœ… Found active_events.json, copying..."
            cp -f ../temp_data/active_events.json data_output/
          else
            echo "âŒ ERROR: active_events.json NOT FOUND in temp_data!"
          fi

          if [ -d ../temp_data/archive_events ]; then
            cp -rf ../temp_data/archive_events/* data_output/archive/ || true
          fi
          
          if [ -d ../temp_data/api ]; then
            cp -rf ../temp_data/api/* data_output/api/ || true
          fi
          
          if [ -d ../temp_data/audit_logs ]; then
            cp -rf ../temp_data/audit_logs/* data_output/audit_logs/ || true
          fi

          if [ -d ../temp_data/completed_events ]; then
            cp -rf ../temp_data/completed_events/* data_output/completed_events/ || true
          fi
          
          if [ -f ../temp_data/regime_changes.json ]; then
            cp -f ../temp_data/regime_changes.json data_output/
          fi
          
          # 3. [ì§„ë‹¨] ë³µì‚¬ í›„ data_output ìƒíƒœ í™•ì¸
          echo "ğŸ” [DEBUG] Listing files in data_output after copy:"
          ls -l data_output/

          git config --global user.name "Poly-Nexus Bot"
          git config --global user.email "bot@polynexus.com"
          
          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add .
          
          # 4. [ê°•ì œ] ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Git Status:"
          git status
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected by Git."
          else
            git commit -m "ğŸ§  Update Data Assets (Debug Run) [$(date)]"
            git push
          fi

      # Public ë°°í¬ ë¶€ë¶„ (ìƒëµí•˜ê±°ë‚˜ ê¸°ì¡´ ìœ ì§€)
      - name: Checkout Public Face
        uses: actions/checkout@v4
        with:
          path: public-face

      - name: Push Intelligence to Public
        run: |
          cd public-face
          mkdir -p docs/data
          
          if [ -f ../temp_data/latest_intelligence.json ]; then
            cp -f ../temp_data/latest_intelligence.json docs/data/
          fi
          
          if [ -f ../temp_data/regime_changes.json ]; then
            cp -f ../temp_data/regime_changes.json docs/data/
          fi
          
          # Security Cleanup
          if [ -d docs/data/api ]; then rm -rf docs/data/api; fi
          if [ -d docs/data/audit_logs ]; then rm -rf docs/data/audit_logs; fi
          if [ -d docs/data/archive ]; then rm -rf docs/data/archive; fi
          if [ -d docs/data/completed_events ]; then rm -rf docs/data/completed_events; fi
          
          git config --global user.name "Poly-Nexus Bot"
          git config --global user.email "bot@polynexus.com"
          
          git add docs/data/
          
          if git diff --staged --quiet; then
            echo "âœ… No public changes."
          else
            git commit -m "ğŸ“¢ Update Dashboard [$(date)]"
            git push
          fi