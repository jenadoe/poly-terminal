<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLY-NEXUS // INTEGRITY ORACLE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg:        #0d1420;
            --bg-2:      #111827;
            --bg-card:   #161f2e;
            --blue:      #60a5fa;
            --blue-dim:  #3b82f6;
            --blue-glow: rgba(96,165,250,0.15);
            --text-hi:   #e2e8f0;
            --text:      #94a3b8;
            --text-mid:  #6b82a0;
            --text-dim:  #3d5068;
            --border:    #1e2d42;
            --border-hi: #2d4260;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'Syne', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--mono);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content:''; position:fixed; inset:0;
            background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.022) 3px,rgba(0,0,0,0.022) 4px);
            pointer-events:none; z-index:9999;
        }

        /* ── TOPBAR ── */
        .topbar {
            display:flex; align-items:center; justify-content:space-between;
            padding:8px 32px; border-bottom:1px solid var(--border);
            background:#0a0f18; font-size:0.72rem; color:var(--text-dim); letter-spacing:0.1em;
        }
        .topbar-left { display:flex; gap:24px; }
        .live-dot {
            display:inline-block; width:5px; height:5px; border-radius:50%;
            background:var(--blue); box-shadow:0 0 5px var(--blue);
            animation:pulse 2.4s infinite; vertical-align:middle; margin-right:5px;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
        #live-clock { color:var(--text-mid); }

        /* ── HEADER ── */
        header {
            padding:28px 32px 20px; border-bottom:1px solid var(--border);
            display:flex; align-items:flex-end; justify-content:space-between;
            flex-wrap:wrap; gap:16px;
            background:linear-gradient(180deg,#0a0f18 0%,var(--bg) 100%);
        }
        .logo h1 { font-family:var(--sans); font-size:2rem; font-weight:800; letter-spacing:0.02em; color:var(--text-hi); line-height:1; }
        .logo h1 span { color:var(--blue); }
        .logo-sub { margin-top:6px; font-size:0.72rem; color:var(--text-dim); letter-spacing:0.15em; text-transform:uppercase; }
        .cursor {
            display:inline-block; width:8px; height:0.85em; background:var(--blue);
            vertical-align:text-bottom; animation:blink 1.1s step-end infinite; opacity:0.75;
        }
        @keyframes blink { 0%,100%{opacity:0.75} 50%{opacity:0} }
        .header-meta { font-size:0.72rem; color:var(--text-mid); text-align:right; line-height:2; letter-spacing:0.07em; }
        .header-meta strong { color:var(--text); }

        /* ── KPI ── */
        .container { padding:24px 32px; max-width:1440px; margin:0 auto; }
        .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:24px; }
        .kpi-card {
            background:var(--bg-card); border:1px solid var(--border);
            border-left:2px solid var(--border-hi); border-radius:6px; padding:16px 20px;
        }
        .kpi-card.primary { border-left-color:var(--blue); }
        .kpi-label { font-size:0.62rem; letter-spacing:0.13em; text-transform:uppercase; color:var(--text-mid); margin-bottom:6px; }
        .kpi-value { font-size:2rem; font-weight:700; line-height:1; color:var(--text-hi); }
        .kpi-card.primary .kpi-value { color:var(--blue); text-shadow:0 0 14px var(--blue-glow); }
        .kpi-sub { margin-top:6px; font-size:0.62rem; color:var(--text-dim); }

        /* ── CHARTS ── */
        .chart-grid { display:grid; grid-template-columns:280px 1fr; gap:12px; margin-bottom:28px; }
        .chart-card { background:var(--bg-card); border:1px solid var(--border); border-radius:6px; padding:18px; }
        .chart-card h3 { font-size:0.62rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--text-mid); margin-bottom:14px; }
        .chart-wrap { position:relative; height:210px; }

        /* ── SECTION HEAD ── */
        .section-head {
            display:flex; align-items:center; gap:10px;
            margin-bottom:4px; font-size:0.72rem;
            letter-spacing:0.14em; text-transform:uppercase;
            color:var(--text-hi); font-weight:600;
        }
        .section-head::after { content:''; flex:1; height:1px; background:var(--border); }
        .section-tag {
            background:rgba(59,130,246,0.1); color:#7eaee8;
            border:1px solid rgba(59,130,246,0.18);
            padding:2px 8px; border-radius:3px; font-size:0.62rem; font-weight:500;
        }
        .section-desc {
            font-size:0.7rem; color:var(--text-dim); margin-bottom:14px;
            letter-spacing:0.04em; padding-left:2px;
        }

        /* ── STATE GROUP WRAPPER ── */
        .state-group { margin-bottom:32px; }

        /* ── EVENT CARDS ── */
        .event-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; }
        @media(max-width:1280px) { .event-grid { grid-template-columns:repeat(4,1fr); } }
        @media(max-width:1024px) { .event-grid { grid-template-columns:repeat(3,1fr); } .chart-grid { grid-template-columns:1fr; } .kpi-grid { grid-template-columns:repeat(2,1fr); } }
        @media(max-width:640px)  { .event-grid { grid-template-columns:repeat(2,1fr); } .container,.topbar,header { padding-left:16px; padding-right:16px; } }

        .event-card {
            background:var(--bg-card); border:1px solid var(--border);
            border-radius:6px; padding:14px;
            cursor:pointer; transition:border-color 0.15s, transform 0.12s;
            position:relative;
            display:flex; flex-direction:column;
        }
        .event-card:hover { border-color:var(--border-hi); transform:translateY(-2px); }
        .event-card:active { transform:translateY(0); }

        /* left accent per state */
        .event-card.s-citable   { border-left:2px solid rgba(96,165,250,0.7); }
        .event-card.s-active    { border-left:2px solid rgba(52,211,153,0.6); }
        .event-card.s-macro     { border-left:2px solid rgba(251,191,36,0.65); }
        .event-card.s-low       { border-left:2px solid rgba(71,85,105,0.45); }

        .card-score {
            font-size:1.6rem; font-weight:700; line-height:1;
            color:var(--text-hi); margin-bottom:8px;
        }
        .card-title {
            font-size:0.75rem; color:var(--text); line-height:1.45;
            display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
            line-clamp:3;
            overflow:hidden; font-weight:500;
            flex:1;
        }
        .card-meta { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
        .card-vol { font-size:0.62rem; color:var(--text-dim); }
        .card-macro { font-size:0.6rem; color:var(--text-dim); }

        .card-bars { margin-top:10px; display:flex; flex-direction:column; gap:4px; }
        .card-bar-row { display:flex; align-items:center; gap:5px; }
        .card-bar-key { font-size:0.5rem; color:var(--text-dim); width:24px; flex-shrink:0; }
        .card-bar-bg  { flex:1; height:2px; background:var(--border); border-radius:2px; overflow:hidden; }
        .card-bar-fill { height:100%; border-radius:2px; background:var(--blue); }
        .bar-liq { background:#60a5fa; }
        .bar-eff { background:#34d399; }
        .bar-ind { background:#a78bfa; }
        .bar-conv{ background:#f472b6; }

        .card-cat {
            display:inline-block; font-size:0.5rem; padding:1px 5px;
            border-radius:2px; background:var(--border); color:var(--text-dim);
            letter-spacing:0.06em; text-transform:uppercase; margin-bottom:6px;
        }

        .card-arrow {
            position:absolute; top:12px; right:12px;
            font-size:0.6rem; color:var(--text-dim);
            opacity:0; transition:opacity 0.15s;
        }
        .event-card:hover .card-arrow { opacity:1; }

        .panel-overlay {
            position:fixed; inset:0; background:rgba(10,15,24,0.6);
            z-index:100; opacity:0; pointer-events:none;
            transition:opacity 0.2s;
        }
        .panel-overlay.open { opacity:1; pointer-events:all; }

        .detail-panel {
            position:fixed; top:0; right:0; bottom:0; width:440px;
            background:var(--bg-2); border-left:1px solid var(--border-hi);
            z-index:101; transform:translateX(100%);
            transition:transform 0.25s cubic-bezier(0.4,0,0.2,1);
            display:flex; flex-direction:column;
            overflow:hidden;
        }
        .detail-panel.open { transform:translateX(0); }
        @media(max-width:480px) { .detail-panel { width:100%; } }

        .panel-header {
            padding:20px 24px; border-bottom:1px solid var(--border);
            display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
            background:var(--bg-card);
        }
        .panel-close {
            background:none; border:1px solid var(--border-hi); color:var(--text-mid);
            padding:4px 10px; border-radius:4px; cursor:pointer; font-family:var(--mono);
            font-size:0.7rem; flex-shrink:0; transition:color 0.15s, border-color 0.15s;
        }
        .panel-close:hover { color:var(--text-hi); border-color:var(--text-mid); }

        .panel-score-row { display:flex; align-items:baseline; gap:12px; margin-bottom:8px; }
        .panel-score { font-size:2.8rem; font-weight:700; color:var(--text-hi); line-height:1; }
        .panel-badge {
            display:inline-block; padding:4px 10px; border-radius:4px;
            font-size:0.6rem; font-weight:600; letter-spacing:0.1em; text-transform:uppercase;
            border:1px solid transparent;
        }
        .badge-citable  { color:#93c5fd; border-color:#1e3a5f; background:rgba(59,130,246,0.08); }
        .badge-active   { color:var(--text); border-color:var(--border-hi); }
        .badge-macro    { color:#fbbf24; border-color:rgba(251,191,36,0.3); background:rgba(251,191,36,0.06); }
        .badge-low      { color:var(--text-dim); border-color:var(--border); }

        .panel-title { font-size:0.88rem; color:var(--text-hi); line-height:1.5; font-weight:500; }

        .panel-body { flex:1; overflow-y:auto; padding:20px 24px; }
        .panel-body::-webkit-scrollbar { width:4px; }
        .panel-body::-webkit-scrollbar-track { background:transparent; }
        .panel-body::-webkit-scrollbar-thumb { background:var(--border-hi); border-radius:2px; }

        .panel-section { margin-bottom:22px; }
        .panel-section-label {
            font-size:0.58rem; letter-spacing:0.14em; text-transform:uppercase;
            color:var(--text-dim); margin-bottom:10px; font-weight:500;
        }

        /* Component bars in panel */
        .panel-bars { display:flex; flex-direction:column; gap:8px; }
        .panel-bar-row { display:flex; align-items:center; gap:10px; }
        .panel-bar-name { font-size:0.65rem; color:var(--text-mid); width:100px; flex-shrink:0; }
        .panel-bar-bg { flex:1; height:5px; background:var(--border); border-radius:3px; overflow:hidden; }
        .panel-bar-fill { height:100%; border-radius:3px; background:var(--blue); transition:width 0.6s cubic-bezier(0.4,0,0.2,1); }
        .panel-bar-fill.bar-liq  { background:#60a5fa; }
        .panel-bar-fill.bar-eff  { background:#34d399; }
        .panel-bar-fill.bar-ind  { background:#a78bfa; }
        .panel-bar-fill.bar-conv { background:#f472b6; }
        .panel-bar-val { font-size:0.65rem; color:var(--text); width:32px; text-align:right; font-variant-numeric:tabular-nums; }

        /* Stat grid in panel */
        .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .stat-item { background:var(--bg-card); border:1px solid var(--border); border-radius:5px; padding:10px 14px; }
        .stat-label { font-size:0.58rem; color:var(--text-dim); letter-spacing:0.1em; text-transform:uppercase; margin-bottom:4px; }
        .stat-value { font-size:1.1rem; font-weight:700; color:var(--text-hi); font-variant-numeric:tabular-nums; }

        /* Sparkline in panel */
        .panel-sparkline { width:100%; height:60px; border-radius:4px; background:var(--bg-card); border:1px solid var(--border); display:block; }

        /* Context note */
        .context-note {
            background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.15);
            border-radius:5px; padding:12px 14px;
            font-size:0.7rem; color:var(--text-mid); line-height:1.6;
        }
        .context-note strong { color:var(--text); }

        .panel-footer { padding:16px 24px; border-top:1px solid var(--border); background:var(--bg-card); }
        .view-btn {
            display:block; text-align:center; padding:10px;
            background:var(--blue); color:#fff; border-radius:5px;
            text-decoration:none; font-family:var(--mono);
            font-size:0.72rem; font-weight:600; letter-spacing:0.08em;
            transition:background 0.15s;
        }
        .view-btn:hover { background:var(--blue-dim); }

        /* Empty state */
        .empty-state { padding:20px; color:var(--text-dim); font-size:0.72rem; letter-spacing:0.06em; }

        /* Footer */
        footer {
            padding:16px 32px; border-top:1px solid var(--border);
            display:flex; justify-content:space-between;
            font-size:0.65rem; color:var(--text-dim); background:var(--bg-2);
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-left">
        <span><span class="live-dot"></span>SYSTEM ONLINE</span>
        <span>ENGINE V4.1</span>
    </div>
    <span id="live-clock">--:--:-- UTC</span>
</div>

<header>
    <div class="logo">
        <h1>POLY<span>-NEXUS</span><span class="cursor"></span></h1>
        <div class="logo-sub">// Prediction Market Integrity Oracle</div>
    </div>
    <div class="header-meta">
        <div>UPDATED <strong id="last-update">—</strong></div>
        <div>ENGINE <strong>V4.1 // NEXUS SCORE™</strong></div>
    </div>
</header>

<div class="container">

    <!-- KPIs -->
    <div class="kpi-grid" style="margin-top:24px;">
        <div class="kpi-card primary">
            <div class="kpi-label">Integrity Index</div>
            <div class="kpi-value" id="integrity-index">—</div>
            <div class="kpi-sub" id="integrity-grade">—</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Market Regime</div>
            <div class="kpi-value" id="market-regime">—</div>
            <div class="kpi-sub">SYSTEM-WIDE</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Citable Markets</div>
            <div class="kpi-value" id="high-conf-count">—</div>
            <div class="kpi-sub">HIGH CONFIDENCE</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Tracked</div>
            <div class="kpi-value" id="total-markets">—</div>
            <div class="kpi-sub">ACTIVE EVENTS</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
        <div class="chart-card">
            <h3>STATE DISTRIBUTION</h3>
            <div class="chart-wrap"><canvas id="stateChart"></canvas></div>
        </div>
        <div class="chart-card">
            <h3>NEXUS COMPONENT AVERAGE — ALL MARKETS</h3>
            <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
        </div>
    </div>

    <!-- State-grouped event cards -->
    <div id="state-groups"></div>

</div>

<!-- Detail Panel -->
<div class="panel-overlay" id="overlay" onclick="closePanel()"></div>
<div class="detail-panel" id="detail-panel">
    <div class="panel-header">
        <div style="flex:1">
            <div class="panel-score-row">
                <span class="panel-score" id="p-score">—</span>
                <span class="panel-badge" id="p-badge">—</span>
            </div>
            <div class="panel-title" id="p-title">—</div>
        </div>
        <button class="panel-close" onclick="closePanel()">✕ CLOSE</button>
    </div>
    <div class="panel-body">
        <div class="panel-section">
            <div class="panel-section-label">INTEGRITY BREAKDOWN</div>
            <div class="panel-bars" id="p-bars"></div>
        </div>
        <div class="panel-section">
            <div class="panel-section-label">MARKET STATS</div>
            <div class="stat-grid" id="p-stats"></div>
        </div>
        <div class="panel-section">
            <div class="panel-section-label">PRICE TREND</div>
            <canvas class="panel-sparkline" id="p-sparkline" height="60"></canvas>
        </div>
        <div class="panel-section">
            <div class="panel-section-label">CONTEXT</div>
            <div class="context-note" id="p-context"></div>
        </div>
    </div>
    <div class="panel-footer">
        <a class="view-btn" id="p-link" href="#" target="_blank">VIEW ON POLYMARKET →</a>
    </div>
</div>

<footer>
    <span>POLY-NEXUS © 2026 // INTEGRITY ORACLE</span>
    <span id="footer-clock"></span>
</footer>

<script>
const DATA_URL = './data/latest_intelligence.json';

const MOCK = [
    {id:"1",slug:"fed-rate-cut-march",       question:"Will the Fed cut rates at the March FOMC meeting?",          category:"Finance",     nexus_score:91.2,market_state:"High Confidence",macro_sensitivity:0.08,volume:14200000,sparkline:[{p:.55},{p:.58},{p:.61},{p:.60},{p:.63},{p:.62},{p:.65}],c1:93,c2:100,c3:88,c4:78},
    {id:"2",slug:"trump-crypto-eo",           question:"Will Trump sign an executive order on crypto before March?",  category:"Crypto",     nexus_score:87.6,market_state:"High Confidence",macro_sensitivity:0.12,volume:9800000, sparkline:[{p:.72},{p:.74},{p:.71},{p:.75},{p:.78},{p:.76},{p:.79}],c1:87,c2:96,c3:82,c4:71},
    {id:"3",slug:"ukraine-ceasefire",         question:"Will Ukraine and Russia reach a ceasefire by June 2026?",    category:"Geopolitics", nexus_score:83.4,market_state:"High Confidence",macro_sensitivity:0.06,volume:7400000, sparkline:[{p:.31},{p:.33},{p:.35},{p:.34},{p:.36},{p:.37},{p:.36}],c1:82,c2:94,c3:91,c4:65},
    {id:"4",slug:"apple-foldable-wwdc",       question:"Will Apple announce a foldable iPhone at WWDC 2026?",        category:"Tech",       nexus_score:78.1,market_state:"Active",         macro_sensitivity:0.04,volume:5100000, sparkline:[{p:.42},{p:.44},{p:.40},{p:.43},{p:.45},{p:.44},{p:.46}],c1:74,c2:91,c3:94,c4:58},
    {id:"5",slug:"btc-120k-q1",               question:"Will BTC exceed $120k before end of Q1 2026?",               category:"Crypto",     nexus_score:73.8,market_state:"Active",         macro_sensitivity:0.71,volume:22100000,sparkline:[{p:.48},{p:.52},{p:.49},{p:.55},{p:.51},{p:.53},{p:.50}],c1:98,c2:89,c3:41,c4:52},
    {id:"6",slug:"democrat-senate-2026",      question:"Will the Democrats win the 2026 Senate Midterms?",           category:"Politics",   nexus_score:72.3,market_state:"Active",         macro_sensitivity:0.03,volume:6700000, sparkline:[{p:.44},{p:.45},{p:.43},{p:.46},{p:.44},{p:.45},{p:.44}],c1:77,c2:92,c3:96,c4:44},
    {id:"7",slug:"musk-doge-july",            question:"Will Elon Musk still be at DOGE by July 2026?",              category:"Politics",   nexus_score:68.9,market_state:"Active",         macro_sensitivity:0.09,volume:4300000, sparkline:[{p:.62},{p:.60},{p:.58},{p:.61},{p:.59},{p:.60},{p:.58}],c1:71,c2:88,c3:84,c4:38},
    {id:"8",slug:"eth-5000-june",             question:"Will ETH reach $5000 before June 2026?",                     category:"Crypto",     nexus_score:54.4,market_state:"Macro-Driven",   macro_sensitivity:0.82,volume:11500000,sparkline:[{p:.35},{p:.38},{p:.41},{p:.44},{p:.39},{p:.42},{p:.38}],c1:87,c2:84,c3:23,c4:30},
    {id:"9",slug:"cpi-4pct-2026",             question:"Will inflation (CPI) exceed 4% in any month of 2026?",       category:"Finance",    nexus_score:61.2,market_state:"Macro-Driven",   macro_sensitivity:0.72,volume:2800000, sparkline:[{p:.28},{p:.30},{p:.29},{p:.32},{p:.31},{p:.30},{p:.32}],c1:60,c2:86,c3:32,c4:51},
    {id:"10",slug:"ai-lab-breach-2026",       question:"Will any major AI lab have a data breach in 2026?",          category:"Tech",       nexus_score:42.1,market_state:"Low Liquidity",  macro_sensitivity:0.01,volume:85000,   sparkline:[{p:.18},{p:.19},{p:.18},{p:.20},{p:.19},{p:.19},{p:.20}],c1:22,c2:86,c3:94,c4:11},
];

let stateInst=null, radarInst=null, panelSparkInst=null;
let allData=[];

// ── UTILS ──────────────────────────────────────────────────
function tickClock(){
    const n=new Date();
    const t=[n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()].map(v=>String(v).padStart(2,'0')).join(':')+' UTC';
    document.getElementById('live-clock').textContent=t;
    const f=document.getElementById('footer-clock');
    if(f) f.textContent=t;
}
setInterval(tickClock,1000); tickClock();

function fmtVol(n){
    if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B';
    if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
    if(n>=1e3) return '$'+(n/1e3).toFixed(0)+'K';
    return '$'+n;
}
function animateCount(el,target,dec=0,ms=800){
    if(!el) return;
    const s=performance.now();
    const step=now=>{
        const p=Math.min((now-s)/ms,1),e=1-Math.pow(1-p,3);
        el.textContent=(target*e).toFixed(dec);
        if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
}
function cleanQuestion(q){
    if(!q) return q;
    const sep = q.indexOf('?: ');
    if(sep === -1) return q;
    const after = q.slice(sep + 3).trim();
    return after || q.slice(0, sep + 1).trim();
}

// ── STATE CONFIG ───────────────────────────────────────────
const STATES = [
    {
        key: 'citable',
        match: s => s.includes('High Confidence'),
        label: 'HIGH CONFIDENCE',
        tag: 'CITABLE',
        cardCls: 's-citable',
        badgeCls: 'badge-citable',
        badgeText: 'CITABLE',
        desc: 'Strong liquidity, efficient pricing, and low macro dependency. These markets are structurally sound for citation and research use.',
        context: d => {
            const subs = {Liquidity:d.c1||0, Efficiency:d.c2||0, Independence:d.c3||0, Convergence:d.c4||0};
            const weakest = Object.entries(subs).sort((a,b)=>a[1]-b[1])[0];
            const riskNote = {
                Liquidity: 'watch for depth changes near resolution — thin liquidity can cause sharp repricing.',
                Efficiency: 'monitor probability sum for late-stage drift.',
                Independence: 'low-level macro correlation present — not disqualifying but watch on high-volatility days.',
                Convergence: 'outcomes have not fully converged yet — state may upgrade further as resolution approaches.',
            }[weakest[0]];
            if(weakest[1] < 85){
                return `Structural integrity verified. Weakest dimension is <strong>${weakest[0]} (${weakest[1].toFixed(0)}/100)</strong> — ${riskNote}`;
            }
            const strongest = Object.entries(subs).sort((a,b)=>b[1]-a[1])[0];
            return `All four integrity dimensions above threshold. Score driven by high <strong>${strongest[0].toLowerCase()}</strong> — market has reached structural maturity and is safe to cite.`;
        },
    },
    {
        key: 'active',
        match: s => s.includes('Active'),
        label: 'ACTIVE',
        tag: 'PRICE DISCOVERY',
        cardCls: 's-active',
        badgeCls: 'badge-active',
        badgeText: 'ACTIVE',
        desc: 'Structurally sound markets currently in active price discovery. Scores reflect real-time information aggregation.',
        context: d => {
            const cnv = d.c4||0;
            const score = parseFloat(d.nexus_score)||0;
            if(score >= 75){
                return `Near High Confidence threshold (score <strong>${score}</strong>). Convergence at ${cnv.toFixed(0)}/100 — one strong price move toward resolution could push this to citable status.`;
            } else if(cnv < 60){
                return `Active price discovery ongoing — convergence at <strong>${cnv.toFixed(0)}/100</strong> indicates outcomes have not yet stabilized. Watch for HC transition as resolution date approaches.`;
            }
            return `Functional market with macro sensitivity of <strong>${(d.macro_sensitivity||0).toFixed(2)}</strong> — within acceptable range. Independence at ${(d.c3||0).toFixed(0)}/100 confirms event-driven pricing.`;
        },
    },
    {
        key: 'macro',
        match: s => s.includes('Macro') || s.includes('Volatile'),
        label: 'MACRO-DRIVEN',
        tag: 'EXTERNAL DEPENDENCY',
        cardCls: 's-macro',
        badgeCls: 'badge-macro',
        badgeText: 'MACRO-DRIVEN',
        desc: 'Price movements correlated with external macro factors (BTC, SPY, Rates). Independence score suppressed. Interpret probabilities as sentiment, not event signal.',
        context: d => {
            const cat = d.category||'';
            const financialCats = ['Crypto','Finance','Economy'];
            const beta = (d.macro_sensitivity||0).toFixed(2);
            const ind = (d.c3||0).toFixed(0);
            if(financialCats.includes(cat)){
                return `Confirmed macro dependency in a <strong>${cat}</strong> market — price is tracking external assets directly (β ${beta}). Independence at ${ind}/100. Probability reflects sentiment, not event fundamentals.`;
            }
            return `Macro signal detected in a <strong>${cat||'non-financial'}</strong> market (β ${beta}). Likely cause: correlated news cycle rather than genuine asset dependency. Independence ${ind}/100 — correlation may dissolve as event-specific information emerges.`;
        },
    },
    {
        key: 'low',
        match: () => true,
        label: 'LOW LIQUIDITY',
        tag: 'INSUFFICIENT DATA',
        cardCls: 's-low',
        badgeCls: 'badge-low',
        badgeText: 'SPARSE DATA',
        desc: 'Thin liquidity or insufficient observation history. Nexus Score may not fully reflect true market quality.',
        context: d => {
            const vol = d.volume||0;
            const liq = (d.c1||0).toFixed(0);
            const eff = (d.c2||0).toFixed(0);
            if(vol < 100000){
                return `Thin market: <strong>${fmtVol(vol)}</strong> total volume is below the threshold for reliable price discovery. Sub-scores are statistically unreliable at this depth — Liquidity at ${liq}/100.`;
            }
            return `Despite ${fmtVol(vol)} volume, structural integrity is insufficient. Efficiency ${eff}/100 suggests probability sum may be drifting — possible unresolved outcome ambiguity.`;
        },
    },
];

function getState(market_state){
    return STATES.find(st=>st.match(market_state)) || STATES[3];
}

// ── KPIs ──────────────────────────────────────────────────
function renderKPIs(data){
    const total=data.length;
    const hc=data.filter(d=>d.market_state.includes('High Confidence')).length;
    const scores=data.map(d=>parseFloat(d.nexus_score)||0);
    const idx=scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
    animateCount(document.getElementById('integrity-index'),idx,1);
    document.getElementById('integrity-grade').textContent=idx>=80?'INSTITUTIONAL GRADE':idx>=60?'STRUCTURED':'FRAGMENTED';
    const macroCount=data.filter(d=>d.market_state.includes('Macro')||d.market_state.includes('Volatile')).length;
    const macroPct=total ? macroCount/total : 0;
    document.getElementById('market-regime').textContent=macroPct>=0.3?'MACRO-STRESSED':idx>=70?'STABLE':'TRANSITIONAL';
    animateCount(document.getElementById('high-conf-count'),hc,0,700);
    animateCount(document.getElementById('total-markets'),total,0,700);
    document.getElementById('last-update').textContent=new Date().toISOString().replace('T',' ').slice(0,19)+' UTC';
}

// ── CHARTS ────────────────────────────────────────────────
function renderStateChart(data){
    const counts={};
    data.forEach(d=>{
        const label=getState(d.market_state).label;
        counts[label]=(counts[label]||0)+1;
    });
    // 색상: 어두운 배경에서 선명하게 대비되는 4색
    const colorMap={
        'HIGH CONFIDENCE':'rgba(96,165,250,0.70)',   // 밝은 블루
        'ACTIVE':         'rgba(52,211,153,0.60)',   // 에메랄드 그린
        'MACRO-DRIVEN':   'rgba(251,191,36,0.70)',   // 앰버 골드
        'LOW LIQUIDITY':  'rgba(71,85,105,0.55)',    // 슬레이트 (의도적으로 어둡게 — 중요도 낮음)
    };
    const borderMap={
        'HIGH CONFIDENCE':'rgba(147,197,253,0.5)',
        'ACTIVE':         'rgba(110,231,183,0.5)',
        'MACRO-DRIVEN':   'rgba(253,211,77,0.5)',
        'LOW LIQUIDITY':  'rgba(100,116,139,0.4)',
    };
    const labels=Object.keys(counts);
    const ctx=document.getElementById('stateChart').getContext('2d');
    if(stateInst) stateInst.destroy();
    stateInst=new Chart(ctx,{
        type:'doughnut',
        data:{labels,datasets:[{
            data:Object.values(counts),
            backgroundColor:labels.map(l=>colorMap[l]||'rgba(40,55,75,0.6)'),
            borderColor:labels.map(l=>borderMap[l]||'rgba(60,75,100,0.3)'),
            borderWidth:1,
            hoverOffset:6,
        }]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{
            legend:{position:'right',labels:{
                color:'#8fa3bc',
                font:{family:"'JetBrains Mono',monospace",size:10},
                boxWidth:10, boxHeight:10, padding:12,
                usePointStyle:true, pointStyle:'rectRounded',
            }},
            tooltip:{backgroundColor:'#1e2d42',borderColor:'#344d6a',borderWidth:1,titleColor:'#d1dae8',bodyColor:'#8fa3bc',
                titleFont:{family:"'JetBrains Mono',monospace",size:10},bodyFont:{family:"'JetBrains Mono',monospace",size:10},
                callbacks:{label:c=>`  ${c.label}: ${c.raw}`}
            }
        }}
    });
}

function renderRadarChart(data){
    const n=data.length||1;
    const s=data.reduce((a,d)=>({c1:a.c1+(d.c1||0),c2:a.c2+(d.c2||0),c3:a.c3+(d.c3||0),c4:a.c4+(d.c4||0)}),{c1:0,c2:0,c3:0,c4:0});
    const vals=[s.c1/n,s.c2/n,s.c3/n,s.c4/n];
    const ctx=document.getElementById('radarChart').getContext('2d');
    if(radarInst) radarInst.destroy();
    radarInst=new Chart(ctx,{
        type:'radar',
        data:{labels:['LIQUIDITY','EFFICIENCY','INDEPENDENCE','CONVERGENCE'],datasets:[{data:vals,
            backgroundColor:'rgba(59,130,246,0.10)',
            borderColor:'rgba(96,165,250,0.55)',
            pointBackgroundColor:'rgba(96,165,250,0.9)',
            pointBorderColor:'rgba(96,165,250,0.3)',
            pointRadius:4,
            pointHoverRadius:5,
            borderWidth:1.5,
        }]},
        options:{responsive:true,maintainAspectRatio:false,
            scales:{r:{
                min:0, max:100,
                ticks:{display:false},
                grid:{color:'rgba(70,100,140,0.45)'},        // 등고선 훨씬 밝게
                angleLines:{color:'rgba(70,100,140,0.35)'},  // 중심선도 같이
                pointLabels:{color:'#8fa3bc',font:{family:"'JetBrains Mono',monospace",size:10}},
            }},
            plugins:{legend:{display:false},
                tooltip:{backgroundColor:'#1e2d42',borderColor:'#344d6a',borderWidth:1,titleColor:'#d1dae8',bodyColor:'#8fa3bc',
                    titleFont:{family:"'JetBrains Mono',monospace",size:10},bodyFont:{family:"'JetBrains Mono',monospace",size:10},
                    callbacks:{label:c=>` ${(+c.formattedValue).toFixed(1)}`}}}}
    });
}

// ── SPARKLINE ─────────────────────────────────────────────
function drawSparkline(canvas, pts, color='rgba(148,163,184,0.55)'){
    if(!canvas||!pts||pts.length<2) return;
    const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const vals=pts.map(d=>typeof d==='object'?d.p:+d);
    const mn=Math.min(...vals), mx=Math.max(...vals), rng=mx-mn||0.01;
    ctx.beginPath();
    ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.lineJoin='round';
    vals.forEach((v,i)=>{
        const x=(i/(vals.length-1))*W, y=H-((v-mn)/rng)*(H-4)-2;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// ── STATE GROUPS ──────────────────────────────────────────
function renderStateGroups(data){
    const container=document.getElementById('state-groups');
    container.innerHTML='';

    STATES.forEach(st=>{
        const items=data.filter(d=>st.match(d.market_state));
        // exclude events already matched by earlier states
        const group=st.key==='low'
            ? data.filter(d=>!STATES.slice(0,3).some(s2=>s2.match(d.market_state)))
            : data.filter(d=>st.match(d.market_state));

        if(!group.length) return;

        // sort by nexus_score desc, show top 5
        const shown=group.sort((a,b)=>b.nexus_score-a.nexus_score).slice(0,5);

        const wrap=document.createElement('div');
        wrap.className='state-group';
        wrap.innerHTML=`
            <div class="section-head"><span>${st.label}</span><span class="section-tag">${st.tag} · ${group.length}</span></div>
            <div class="section-desc">${st.desc}</div>
            <div class="event-grid" id="grid-${st.key}"></div>
        `;
        container.appendChild(wrap);

        const grid=document.getElementById(`grid-${st.key}`);
        shown.forEach((d,i)=>{
            const card=document.createElement('div');
            card.className=`event-card ${st.cardCls}`;
            const lp=normBar(d.c1), ep=normBar(d.c2), ip=normBar(d.c3), cp=normBar(d.c4);
            card.innerHTML=`
                <span class="card-arrow">↗</span>
                ${d.category ? `<div class="card-cat">${d.category}</div>` : ''}
                <div class="card-score">${d.nexus_score}</div>
                <div class="card-title">${cleanQuestion(d.question)}</div>
                <div class="card-meta">
                    <span class="card-vol">${fmtVol(d.volume||0)}</span>
                    <span class="card-macro">β ${(d.macro_sensitivity||0).toFixed(2)}</span>
                </div>
                <div class="card-bars">
                    <div class="card-bar-row"><span class="card-bar-key">LIQ</span><div class="card-bar-bg"><div class="card-bar-fill bar-liq" style="width:${lp}%"></div></div></div>
                    <div class="card-bar-row"><span class="card-bar-key">EFF</span><div class="card-bar-bg"><div class="card-bar-fill bar-eff" style="width:${ep}%"></div></div></div>
                    <div class="card-bar-row"><span class="card-bar-key">IND</span><div class="card-bar-bg"><div class="card-bar-fill bar-ind" style="width:${ip}%"></div></div></div>
                    <div class="card-bar-row"><span class="card-bar-key">CNV</span><div class="card-bar-bg"><div class="card-bar-fill bar-conv" style="width:${cp}%"></div></div></div>
                </div>
            `;
            card.addEventListener('click', ()=>openPanel(d, st));
            grid.appendChild(card);

            // draw mini sparkline after DOM
            if(d.sparkline){
                // sparklines on cards are bars only (no canvas for perf)
            }
        });
    });
}

// ── DETAIL PANEL ──────────────────────────────────────────
function openPanel(d, st){
    document.getElementById('p-score').textContent=d.nexus_score;

    const badge=document.getElementById('p-badge');
    badge.textContent=st.badgeText;
    badge.className='panel-badge '+st.badgeCls;

    document.getElementById('p-title').textContent=cleanQuestion(d.question);

    // Component bars
    document.getElementById('p-bars').innerHTML=[
        {key:'LIQUIDITY',     val:d.c1, cls:'bar-liq'},
        {key:'EFFICIENCY',    val:d.c2, cls:'bar-eff'},
        {key:'INDEPENDENCE',  val:d.c3, cls:'bar-ind'},
        {key:'CONVERGENCE',   val:d.c4, cls:'bar-conv'},
    ].map(b=>`
        <div class="panel-bar-row">
            <span class="panel-bar-name">${b.key}</span>
            <div class="panel-bar-bg"><div class="panel-bar-fill ${b.cls}" style="width:${normBar(b.val)}%"></div></div>
            <span class="panel-bar-val">${(b.val||0).toFixed(0)}</span>
        </div>
    `).join('');

    // Stats
    document.getElementById('p-stats').innerHTML=`
        <div class="stat-item"><div class="stat-label">VOLUME</div><div class="stat-value">${fmtVol(d.volume||0)}</div></div>
        <div class="stat-item"><div class="stat-label">MACRO BETA</div><div class="stat-value">${(d.macro_sensitivity||0).toFixed(2)}</div></div>
        <div class="stat-item"><div class="stat-label">CURRENT PRICE</div><div class="stat-value">${((d.current_price||0)*100).toFixed(1)}%</div></div>
        <div class="stat-item"><div class="stat-label">CHANGE</div><div class="stat-value">${d.change_since_start>=0?'+':''}${(d.change_since_start||0).toFixed(1)}%</div></div>
    `;

    // Sparkline
    const spCanvas=document.getElementById('p-sparkline');
    spCanvas.width=spCanvas.offsetWidth||380;
    if(d.sparkline) requestAnimationFrame(()=>drawSparkline(spCanvas, d.sparkline,'rgba(96,165,250,0.7)'));

    // Context
    document.getElementById('p-context').innerHTML=st.context(d);

    // Link
    document.getElementById('p-link').href=`https://polymarket.com/event/${d.slug||d.id||''}`;

    document.getElementById('overlay').classList.add('open');
    document.getElementById('detail-panel').classList.add('open');
    document.body.style.overflow='hidden';
}

function closePanel(){
    document.getElementById('overlay').classList.remove('open');
    document.getElementById('detail-panel').classList.remove('open');
    document.body.style.overflow='';
}

document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePanel(); });

// ── INIT ──────────────────────────────────────────────────
async function init(){
    let data=null;
    try{
        const r=await fetch(DATA_URL);
        if(!r.ok) throw new Error();
        const raw=await r.json();
        if(Array.isArray(raw)&&raw.length) data=raw;
    }catch(_){}
    if(!data) data=MOCK;
    allData=data;

    renderKPIs(data);
    renderStateChart(data);
    renderRadarChart(data);
    renderStateGroups(data);
}

init();
setInterval(init, 5*60*1000);
</script>
</body>
</html>