<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poly-Nexus | Integrity Layer</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --accent: #2563eb;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 0;
        }
        h1 { margin: 0; font-size: 2.5rem; letter-spacing: -1px; }
        .subtitle { color: var(--text-sub); font-size: 1.1rem; margin-top: 10px; }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .metric-label { font-size: 0.9rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
        .metric-value { font-size: 2rem; font-weight: 700; margin: 10px 0; color: var(--accent); }
        .metric-sub { font-size: 0.85rem; font-weight: 600; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #fef9c3; color: #854d0e; }
        .grade-c { background: #fee2e2; color: #991b1b; }

        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        .chart-container { position: relative; height: 300px; }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; border-bottom: 2px solid var(--border); color: var(--text-sub); font-size: 0.85rem; }
        td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;
        }
        .status-high { background: #dcfce7; color: #15803d; }
        .status-active { background: #dbeafe; color: #1d4ed8; }
        .status-macro { background: #fef9c3; color: #a16207; }
        .status-low { background: #f1f5f9; color: #64748b; }
        .status-volatile { background: #fee2e2; color: #b91c1c; }

        /* Sparkline */
        .sparkline-canvas { width: 100px; height: 30px; vertical-align: middle; }

        /* Footer */
        footer { text-align: center; padding: 40px; color: var(--text-sub); font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üõ°Ô∏è Poly-Nexus</h1>
        <div class="subtitle">The Oracle Integrity Filter for Prediction Markets</div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;">v3.0 | Live Intelligence</div>
    </header>

    <!-- KPI Section -->
    <div class="kpi-grid">
        <div class="card">
            <div class="metric-label">Integrity Index</div>
            <div class="metric-value" id="integrity-index">-</div>
            <div id="integrity-grade" class="metric-sub">-</div>
        </div>
        <div class="card">
            <div class="metric-label">Market Regime</div>
            <div class="metric-value" id="market-regime">-</div>
            <div class="metric-sub" style="background:#f1f5f9; color:#475569;">System Wide</div>
        </div>
        <div class="card">
            <div class="metric-label">High Confidence</div>
            <div class="metric-value" id="high-conf-count">-</div>
            <div class="metric-sub grade-a">Safe to Cite</div>
        </div>
        <div class="card">
            <div class="metric-label">Active Markets</div>
            <div class="metric-value" id="total-markets">-</div>
            <div class="metric-sub" style="background:#e0e7ff; color:#3730a3;">Tracked</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
        <div class="card">
            <h3>üìä Market State Distribution</h3>
            <div class="chart-container">
                <canvas id="stateChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h3>‚ö†Ô∏è Risk Radar (Volume vs Score)</h3>
            <div class="chart-container">
                <canvas id="riskChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Intelligence Table -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3>üèÜ Top Intelligence (High Confidence)</h3>
            <span style="font-size:0.8rem; color:#64748b;">*Updated Hourly</span>
        </div>
        <div class="table-container">
            <table id="market-table">
                <thead>
                    <tr>
                        <th>Market Question</th>
                        <th>Nexus Score</th>
                        <th>Status</th>
                        <th>Macro Beta</th>
                        <th>Volume</th>
                        <th>Trend (24h)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>Built for <b>Polymarket Builder Program</b> ‚Ä¢ Poly-Nexus Engine V3.0</p>
        <p style="opacity: 0.6;">Data source: Polymarket Gamma API ‚Ä¢ Integrity verification by Poly-Nexus</p>
    </footer>
</div>

<script>
    // --- Configuration ---
    const DATA_URL = './data/latest_intelligence.json';
    
    // --- Global Chart Instances (for memory leak prevention) ---
    let stateChartInstance = null;
    let riskChartInstance = null;

    // --- Utils ---
    function formatCurrency(num) {
        if (num >= 1000000) return "$" + (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return "$" + (num / 1000).toFixed(1) + "K";
        return "$" + num;
    }

    function getStatusClass(status) {
        if (status.includes("High Confidence")) return "status-high";
        if (status.includes("Active")) return "status-active";
        if (status.includes("Macro")) return "status-macro";
        if (status.includes("Volatile")) return "status-volatile";
        return "status-low";
    }

    // --- Sparkline Renderer ---
    function renderSparkline(canvasId, dataPoints) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;

        if (!dataPoints || dataPoints.length < 2) return;

        const minVal = Math.min(...dataPoints.map(d => d.p));
        const maxVal = Math.max(...dataPoints.map(d => d.p));
        const range = maxVal - minVal || 1;

        dataPoints.forEach((pt, i) => {
            const x = (i / (dataPoints.length - 1)) * width;
            const y = height - ((pt.p - minVal) / range) * height; // Invert Y
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    // --- Main Logic ---
    async function initDashboard() {
        try {
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error("Data fetch failed");
            const data = await response.json();
            
            // [Bug Fix] Empty Data Check
            if (!data || data.length === 0) {
                console.warn("No data available");
                return;
            }

            renderKPIs(data);
            renderCharts(data);
            renderTable(data);

        } catch (error) {
            console.error("Dashboard Init Error:", error);
            document.querySelector('.container').innerHTML += `<div style="color:red; text-align:center; margin-top:20px;">‚ö†Ô∏è Failed to load data. Please check connection.</div>`;
        }
    }

    function renderKPIs(data) {
        const total = data.length;
        const highConf = data.filter(d => d.market_state.includes("High Confidence")).length;
        const active = data.filter(d => d.market_state.includes("Active")).length;
        
        // Integrity Index Calc (Weighted)
        // High=1.0, Active=0.5, Others=0
        const rawIndex = ((highConf * 1.0) + (active * 0.5)) / total * 100;
        const integrityIndex = rawIndex.toFixed(1);

        // Update DOM
        document.getElementById('total-markets').innerText = total;
        document.getElementById('high-conf-count').innerText = highConf;
        document.getElementById('integrity-index').innerText = integrityIndex;

        // [Feature] Regime Logic
        let regime = "Transitional";
        if (integrityIndex >= 75) regime = "Stable Bull";
        else if (integrityIndex < 40) regime = "High Stress";
        document.getElementById('market-regime').innerText = regime;

        // [Feature] Grade Label
        const gradeEl = document.getElementById('integrity-grade');
        if (integrityIndex >= 80) { gradeEl.innerText = "Institutional Grade"; gradeEl.className = "metric-sub grade-a"; }
        else if (integrityIndex >= 60) { gradeEl.innerText = "Structured"; gradeEl.className = "metric-sub grade-b"; }
        else { gradeEl.innerText = "Unstable"; gradeEl.className = "metric-sub grade-c"; }
    }

    function renderCharts(data) {
        // 1. State Distribution
        const stateCounts = {};
        data.forEach(d => {
            // Simplify state string (take first part)
            const state = d.market_state.split('|')[0].trim();
            stateCounts[state] = (stateCounts[state] || 0) + 1;
        });

        const ctx1 = document.getElementById('stateChart').getContext('2d');
        
        // [Bug Fix] Destroy previous instance
        if (stateChartInstance) stateChartInstance.destroy();

        stateChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(stateCounts),
                datasets: [{
                    data: Object.values(stateCounts),
                    backgroundColor: ['#22c55e', '#3b82f6', '#eab308', '#ef4444', '#94a3b8']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. Risk Radar (Score vs Volume)
        const ctx2 = document.getElementById('riskChart').getContext('2d');
        
        // [Bug Fix] Destroy previous instance
        if (riskChartInstance) riskChartInstance.destroy();

        // Top 50 markets only for clarity
        const plotData = data.slice(0, 50).map(d => ({
            x: d.nexus_score,
            y: Math.log10(d.volume + 1), // Log scale for visualization
            r: 5,
            label: d.question
        }));

        riskChartInstance = new Chart(ctx2, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Market Position',
                    data: plotData,
                    backgroundColor: '#6366f1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Nexus Score (Integrity)' }, min: 0, max: 100 },
                    y: { title: { display: true, text: 'Liquidity (Log Scale)' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderTable(data) {
        const tbody = document.querySelector('#market-table tbody');
        tbody.innerHTML = ''; // Clear

        // Sort by Score DESC
        const sortedData = data.sort((a, b) => {
        // 1. ÏÉÅÌÉú Ïö∞ÏÑ†ÏàúÏúÑ (High > Active > others)
            const getRank = (status) => {
                if (status.includes("High Confidence")) return 3;
                if (status.includes("Active")) return 2;
                return 1;
            };
            const rankA = getRank(a.market_state);
            const rankB = getRank(b.market_state);
    
            if (rankA !== rankB) return rankB - rankA; // Îì±Í∏â ÎÜíÏùÄ Ïàú
            return b.nexus_score - a.nexus_score;      // Í∞ôÏùÄ Îì±Í∏âÏù¥Î©¥ Ï†êÏàò ÎÜíÏùÄ Ïàú
        }).slice(0, 10);

        sortedData.forEach((row, index) => {
            const tr = document.createElement('tr');
            
            // Sparkline Canvas ID
            const sparkId = `spark-${index}`;
            
            tr.innerHTML = `
                <td style="font-weight:600; color:#334155;">${row.question}</td>
                <td style="font-weight:700; color:${row.nexus_score >= 80 ? '#22c55e' : '#3b82f6'}">${row.nexus_score}</td>
                <td><span class="status-badge ${getStatusClass(row.market_state)}">${row.market_state}</span></td>
                <td>${row.macro_sensitivity}</td>
                <td>${formatCurrency(row.volume)}</td>
                <td><canvas id="${sparkId}" class="sparkline-canvas" width="100" height="30"></canvas></td>
                <td><a href="https://polymarket.com/event/${row.id}" target="_blank" style="text-decoration:none; color:#3b82f6; font-weight:600;">View ‚Üí</a></td>
            `;
            tbody.appendChild(tr);

            // Render Sparkline
            if (row.sparkline) {
                renderSparkline(sparkId, row.sparkline);
            }
        });
    }

    // Run
    initDashboard();

</script>
</body>
</html>