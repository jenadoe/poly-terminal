<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLY-NEXUS // INTEGRITY ORACLE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Background — softer dark navy, not near-black */
            --bg:        #111827;
            --bg-2:      #1a2333;
            --bg-card:   #1e2d42;
            --bg-row:    #1a2333;

            /* Blue — accent only */
            --blue:      #3b82f6;
            --blue-dim:  #2563eb;
            --blue-glow: rgba(59,130,246,0.12);

            /* Text — reduced contrast for eye comfort */
            --text-hi:   #d1dae8;   /* was #f1f5f9 — softer white */
            --text:      #8fa3bc;   /* was #94a3b8 */
            --text-mid:  #6b82a0;   /* was #64748b — slightly brighter */
            --text-dim:  #4e6280;   /* was #475569 — brighter for readability */

            --border:    #243044;
            --border-hi: #344d6a;

            --mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--mono);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.025) 3px,rgba(0,0,0,0.025) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        /* ── TOPBAR ── */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 32px;
            border-bottom: 1px solid var(--border);
            background: #0a0f18;
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }
        .topbar-left { display: flex; gap: 24px; }
        .live-dot {
            display: inline-block; width: 5px; height: 5px;
            border-radius: 50%; background: var(--blue);
            box-shadow: 0 0 5px var(--blue);
            animation: pulse 2.4s infinite;
            vertical-align: middle; margin-right: 5px;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
        #live-clock { color: var(--text-mid); }

        /* ── HEADER ── */
        header {
            padding: 30px 32px 22px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: flex-end;
            justify-content: space-between;
            flex-wrap: wrap; gap: 16px;
            background: linear-gradient(180deg, #0a0f18 0%, var(--bg) 100%);
        }
        .logo h1 {
            font-size: 2rem; font-weight: 700;
            letter-spacing: 0.04em;
            color: var(--text-hi); line-height: 1;
        }
        .logo h1 span { color: var(--blue); }
        .logo-sub {
            margin-top: 6px; font-size: 0.75rem;
            color: var(--text-dim); letter-spacing: 0.15em; text-transform: uppercase;
        }
        .cursor {
            display: inline-block; width: 8px; height: 0.85em;
            background: var(--blue); vertical-align: text-bottom;
            animation: blink 1.1s step-end infinite; opacity: 0.75;
        }
        @keyframes blink { 0%,100%{opacity:0.75} 50%{opacity:0} }
        .header-meta {
            font-size: 0.75rem; color: var(--text-mid);
            text-align: right; line-height: 2; letter-spacing: 0.07em;
        }
        .header-meta strong { color: var(--text); }

        /* ── HERO SPOTLIGHT ── */
        .hero {
            border-bottom: 1px solid var(--border);
            padding: 28px 32px;
            background: var(--bg-2);
        }
        .hero-label {
            font-size: 0.75rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text);
            margin-bottom: 16px;
            font-weight: 500;
        }
        .hero-label span { color: var(--blue); margin-right: 6px; }

        .spotlight-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
        }
        .spotlight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: 2px solid var(--blue-dim);
            border-radius: 6px;
            padding: 20px;
            position: relative;
            transition: border-top-color 0.2s;
        }
        .spotlight-card:hover { border-top-color: var(--blue); }

        .spotlight-score {
            font-size: 2.4rem; font-weight: 700;
            color: var(--text-hi);
            line-height: 1; margin-bottom: 10px;
        }
        .spotlight-title {
            font-size: 0.88rem; color: var(--text);
            line-height: 1.55; margin-bottom: 6px; font-weight: 500;
        }
        .spotlight-cat {
            font-size: 0.68rem; color: var(--text-dim);
            letter-spacing: 0.1em; text-transform: uppercase;
        }
        .spotlight-vol {
            position: absolute; top: 18px; right: 18px;
            font-size: 0.75rem; color: var(--text-mid);
        }
        .spotlight-bars { margin-top: 14px; display: flex; flex-direction: column; gap: 6px; }
        .sp-bar-row { display: flex; align-items: center; gap: 6px; }
        .sp-bar-key { font-size: 0.62rem; color: var(--text-mid); width: 28px; flex-shrink: 0; }
        .sp-bar-bg  { flex:1; height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
        .sp-bar-fill { height:100%; border-radius:2px; background:var(--blue); opacity:0.7; }
        .sp-bar-val { font-size:0.62rem; color:var(--text-mid); width:24px; text-align:right; }

        .hero-empty { color:var(--text-mid); font-size:0.75rem; padding:20px 0; }

        /* ── CONTAINER ── */
        .container { padding: 26px 32px; max-width: 1400px; margin: 0 auto; }

        /* ── SECTION HEAD ── */
        .section-head {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 14px; font-size: 0.72rem;
            letter-spacing: 0.14em; text-transform: uppercase;
            color: var(--text-hi);   /* bright — was var(--text) */
            font-weight: 500;
        }
        .section-head::after { content:''; flex:1; height:1px; background:var(--border); }
        .section-tag {
            background: rgba(59,130,246,0.12);
            color: #7eaee8;
            border: 1px solid rgba(59,130,246,0.2);
            padding: 2px 8px; border-radius: 3px; font-size: 0.65rem;
            font-weight: 500;
        }

        /* ── KPI GRID ── */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px; margin-bottom: 24px;
        }
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 2px solid var(--border-hi);
            border-radius: 6px;
            padding: 18px 22px;
        }
        .kpi-card.primary { border-left-color: var(--blue); }
        .kpi-label {
            font-size: 0.68rem; letter-spacing: 0.13em;
            text-transform: uppercase; color: var(--text-mid);
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 2.2rem; font-weight: 700;
            line-height: 1; color: var(--text-hi);
        }
        /* Only the primary card's value gets blue */
        .kpi-card.primary .kpi-value { color: var(--blue); text-shadow: 0 0 14px var(--blue-glow); }
        .kpi-sub { margin-top: 7px; font-size: 0.68rem; color: var(--text-dim); letter-spacing: 0.06em; }

        /* ── CHART GRID ── */
        .chart-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 14px; margin-bottom: 24px;
        }
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px; padding: 20px;
        }
        .chart-card h3 {
            font-size: 0.7rem; letter-spacing: 0.13em;
            text-transform: uppercase; color: var(--text-mid);
            margin-bottom: 16px;
        }
        .chart-wrap { position:relative; height:230px; }

        /* ── TABLE ── */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px; overflow: hidden; margin-bottom: 40px;
        }
        .table-top {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 13px 20px; border-bottom: 1px solid var(--border);
            background: var(--bg-2);
        }
        .table-top h3 {
            font-size: 0.7rem; letter-spacing: 0.13em;
            text-transform: uppercase; color: var(--text-hi);
            font-weight: 500;
        }
        .table-tag {
            font-size: 0.65rem; color: #7eaee8;
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.18);
            padding: 2px 8px; border-radius: 3px;
        }

        table { width:100%; border-collapse:collapse; }
        thead th {
            padding: 10px 14px; font-size: 0.65rem;
            letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text-mid);
            text-align: left; background: var(--bg-2);
            border-bottom: 1px solid var(--border); white-space: nowrap;
        }
        tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
        tbody tr:hover { background: rgba(30,41,59,0.6); }
        tbody tr:last-child { border-bottom:none; }
        td { padding:13px 14px; vertical-align:middle; }

        .event-title {
            font-size: 0.88rem; font-weight: 500;
            color: var(--text-hi);
            max-width: 320px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.45;
        }
        .event-cat {
            font-size: 0.65rem; color: var(--text-dim);
            margin-top: 3px; letter-spacing: 0.08em; text-transform: uppercase;
        }

        /* Score — white, clean. No blue. */
        .score-cell { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .score-hi  { color: var(--text-hi); }
        .score-mid { color: var(--text); }
        .score-low { color: var(--text-mid); }
        .score-dim { color: var(--text-dim); }

        /* Badges — subtle, text-based differentiation */
        .badge {
            display: inline-block; padding: 4px 9px; border-radius: 3px;
            font-size: 0.63rem; font-weight: 600;
            letter-spacing: 0.09em; text-transform: uppercase;
            white-space: nowrap; border: 1px solid transparent;
        }
        .badge-verified { color: #93c5fd; border-color: #1e3a5f; background: rgba(59,130,246,0.08); }
        .badge-active   { color: var(--text); border-color: var(--border-hi); background: transparent; }
        .badge-caution  { color: var(--text-mid); border-color: var(--border); background: transparent; }
        .badge-low      { color: var(--text-dim); border-color: var(--border); background: transparent; }

        /* Sub-score bars */
        .subscores { display:flex; flex-direction:column; gap:5px; min-width:175px; }
        .subscore-row { display:flex; align-items:center; gap:7px; }
        .subscore-key { font-size:0.62rem; color:var(--text-mid); width:28px; text-transform:uppercase; flex-shrink:0; }
        .bar-bg { flex:1; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
        .bar-fill { height:100%; border-radius:2px; background:var(--blue); transition:width 0.6s cubic-bezier(0.4,0,0.2,1); }
        .bar-liq  { opacity:1.0; }
        .bar-eff  { opacity:0.75; }
        .bar-ind  { opacity:0.55; }
        .bar-conv { opacity:0.88; }
        .subscore-val { font-size:0.62rem; color:var(--text-mid); width:26px; text-align:right; }

        .vol-cell   { color:var(--text); font-variant-numeric:tabular-nums; font-size:0.88rem; }
        .macro-cell { font-size:0.88rem; font-variant-numeric:tabular-nums; color:var(--text); }
        .sparkline-canvas { vertical-align:middle; }

        .link-btn {
            display: inline-block; font-size: 0.7rem;
            color: var(--text-mid); text-decoration: none;
            border: 1px solid var(--border-hi); padding: 4px 10px;
            border-radius: 3px; letter-spacing: 0.06em;
            transition: color 0.15s, border-color 0.15s;
        }
        .link-btn:hover { color: var(--text-hi); border-color: var(--border-hi); }

        /* Row dimming — less aggressive */
        tr.row-caution td { opacity: 0.6; }
        tr.row-low     td { opacity: 0.35; }

        /* ── FOOTER ── */
        footer {
            padding: 20px 32px; border-top: 1px solid var(--border);
            display: flex; justify-content: space-between;
            font-size: 0.7rem; color: var(--text-dim);
            letter-spacing: 0.08em; background: var(--bg-2);
        }

        @media (max-width:1024px) {
            .kpi-grid { grid-template-columns:repeat(2,1fr); }
            .chart-grid { grid-template-columns:1fr; }
            .spotlight-grid { grid-template-columns:1fr; }
        }
        @media (max-width:640px) {
            .container,.hero,header { padding-left:16px; padding-right:16px; }
            .kpi-grid { grid-template-columns:1fr 1fr; }
            .topbar { display:none; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-left">
        <span><span class="live-dot"></span>SYSTEM ONLINE</span>
        <span>ENGINE V3.0</span>
        <span>POLYMARKET // GAMMA API</span>
    </div>
    <span id="live-clock">--:--:-- UTC</span>
</div>

<header>
    <div class="logo">
        <h1>POLY<span>-NEXUS</span><span class="cursor"></span></h1>
        <div class="logo-sub">// Prediction Market Integrity Oracle</div>
    </div>
    <div class="header-meta">
        <div>UPDATED <strong id="last-update">—</strong></div>
        <div>SOURCE <strong>POLYMARKET GAMMA API</strong></div>
        <div>ENGINE <strong>V3.0 // NEXUS SCORE™</strong></div>
    </div>
</header>

<section class="hero">
    <div class="hero-label"><span>//</span>HIGHEST INTEGRITY MARKETS — VERIFIED &amp; CITABLE</div>
    <div class="spotlight-grid" id="spotlight-grid">
        <div class="hero-empty">LOADING...</div>
    </div>
</section>

<div class="container">

    <div class="section-head"><span>SYSTEM STATUS</span><span class="section-tag">LIVE</span></div>
    <div class="kpi-grid">
        <div class="kpi-card primary">
            <div class="kpi-label">Integrity Index</div>
            <div class="kpi-value" id="integrity-index">—</div>
            <div class="kpi-sub" id="integrity-grade">—</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Market Regime</div>
            <div class="kpi-value" id="market-regime">—</div>
            <div class="kpi-sub">SYSTEM-WIDE</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Citable Markets</div>
            <div class="kpi-value" id="high-conf-count">—</div>
            <div class="kpi-sub">HIGH CONFIDENCE</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Tracked</div>
            <div class="kpi-value" id="total-markets">—</div>
            <div class="kpi-sub">ACTIVE EVENTS</div>
        </div>
    </div>

    <div class="section-head"><span>ANALYSIS</span><span class="section-tag">SYSTEM OVERVIEW</span></div>
    <div class="chart-grid">
        <div class="chart-card">
            <h3>DATA STATE DISTRIBUTION</h3>
            <div class="chart-wrap"><canvas id="stateChart"></canvas></div>
        </div>
        <div class="chart-card">
            <h3>NEXUS COMPONENT RADAR — SYSTEM AVERAGE</h3>
            <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
        </div>
    </div>

    <div class="section-head"><span>INTELLIGENCE FEED</span><span class="section-tag">TOP 15 BY VOLUME</span></div>
    <div class="table-card">
        <div class="table-top">
            <h3>TOP 15 EVENTS BY VOLUME — NEXUS SCORE RANKED</h3>
            <span class="table-tag">REFRESHED HOURLY</span>
        </div>
        <div id="table-body-wrap">
            <div style="padding:40px;text-align:center;color:var(--text-dim);font-size:0.72rem;letter-spacing:0.1em;">▋ LOADING</div>
        </div>
    </div>

</div>

<footer>
    <span>POLY-NEXUS © 2026 // INTEGRITY ORACLE</span>
    <span>BUILT FOR POLYMARKET BUILDER PROGRAM</span>
    <span>DATA: POLYMARKET GAMMA API + YFINANCE</span>
</footer>

<script>
const DATA_URL = './data/latest_intelligence.json';

const MOCK = [
    {question:"Will the Fed cut rates at the March FOMC meeting?",        category:"Finance",     nexus_score:91.2,market_state:"High Confidence",macro_sensitivity:0.08,volume:14200000,slug:"fed-rate-cut-march",        sparkline:[0.55,0.58,0.61,0.60,0.63,0.62,0.65],liq:28.1,eff:23.4,ind:14.2,conv:25.5},
    {question:"Will Trump sign an executive order on crypto before March?",category:"Crypto",     nexus_score:87.6,market_state:"High Confidence",macro_sensitivity:0.12,volume:9800000, slug:"trump-crypto-eo-march",      sparkline:[0.72,0.74,0.71,0.75,0.78,0.76,0.79],liq:26.0,eff:22.1,ind:13.5,conv:26.0},
    {question:"Will Ukraine and Russia reach a ceasefire by June 2026?",  category:"Geopolitics", nexus_score:83.4,market_state:"High Confidence",macro_sensitivity:0.06,volume:7400000, slug:"ukraine-russia-ceasefire",   sparkline:[0.31,0.33,0.35,0.34,0.36,0.37,0.36],liq:24.5,eff:21.8,ind:14.7,conv:22.4},
    {question:"Will Apple announce a foldable iPhone at WWDC 2026?",      category:"Tech",        nexus_score:78.1,market_state:"Active",         macro_sensitivity:0.04,volume:5100000, slug:"apple-foldable-iphone-wwdc", sparkline:[0.42,0.44,0.40,0.43,0.45,0.44,0.46],liq:22.0,eff:20.5,ind:14.1,conv:21.5},
    {question:"Will BTC exceed $120k before end of Q1 2026?",            category:"Crypto",      nexus_score:73.8,market_state:"Active",         macro_sensitivity:0.71,volume:22100000,slug:"btc-120k-q1-2026",           sparkline:[0.48,0.52,0.49,0.55,0.51,0.53,0.50],liq:29.5,eff:18.2,ind:6.1, conv:20.0},
    {question:"Will the Democrats win the 2026 Senate Midterms?",         category:"Politics",    nexus_score:72.3,market_state:"Active",         macro_sensitivity:0.03,volume:6700000, slug:"democrat-senate-2026",       sparkline:[0.44,0.45,0.43,0.46,0.44,0.45,0.44],liq:23.0,eff:21.0,ind:14.8,conv:13.5},
    {question:"Will Elon Musk still be at DOGE by July 2026?",           category:"Politics",    nexus_score:68.9,market_state:"Active",         macro_sensitivity:0.09,volume:4300000, slug:"musk-doge-july",             sparkline:[0.62,0.60,0.58,0.61,0.59,0.60,0.58],liq:21.5,eff:20.4,ind:13.0,conv:14.0},
    {question:"Will inflation (CPI) exceed 4% in any month of 2026?",    category:"Finance",     nexus_score:61.2,market_state:"Active",         macro_sensitivity:0.22,volume:2800000, slug:"cpi-4pct-2026",              sparkline:[0.28,0.30,0.29,0.32,0.31,0.30,0.32],liq:18.0,eff:17.5,ind:10.2,conv:15.5},
    {question:"Will ETH reach $5000 before June 2026?",                  category:"Crypto",      nexus_score:54.4,market_state:"Macro-Driven",   macro_sensitivity:0.82,volume:11500000,slug:"eth-5000-june",              sparkline:[0.35,0.38,0.41,0.44,0.39,0.42,0.38],liq:26.0,eff:16.0,ind:3.4, conv:9.0},
    {question:"Will any major AI lab have a data breach in 2026?",        category:"Tech",        nexus_score:42.1,market_state:"Low Liquidity",  macro_sensitivity:0.01,volume:85000,   slug:"ai-lab-breach-2026",         sparkline:[0.18,0.19,0.18,0.20,0.19,0.19,0.20],liq:6.5, eff:18.0,ind:14.1,conv:3.5},
];

let stateInst=null, radarInst=null;

function tickClock(){
    const n=new Date();
    document.getElementById('live-clock').textContent=
        [n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()].map(v=>String(v).padStart(2,'0')).join(':')+' UTC';
}
setInterval(tickClock,1000); tickClock();

function fmtVol(n){
    if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
    if(n>=1e3) return '$'+(n/1e3).toFixed(0)+'K';
    return '$'+n;
}

function animateCount(el,target,decimals=0,ms=800){
    const start=performance.now();
    const step=now=>{
        const p=Math.min((now-start)/ms,1), e=1-Math.pow(1-p,3);
        el.textContent=(target*e).toFixed(decimals);
        if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
}

function stateInfo(state){
    if(state.includes('High Confidence')) return {label:'CITABLE',      cls:'badge-verified', rowCls:''};
    if(state.includes('Active'))          return {label:'ACTIVE',       cls:'badge-active',   rowCls:''};
    if(state.includes('Macro'))           return {label:'MACRO-DRIVEN', cls:'badge-caution',  rowCls:'row-caution'};
    if(state.includes('Volatile'))        return {label:'VOLATILE',     cls:'badge-caution',  rowCls:'row-caution'};
    return                                       {label:'SPARSE DATA',  cls:'badge-low',      rowCls:'row-low'};
}

function scoreClass(s){
    if(s>=80) return 'score-hi';
    if(s>=60) return 'score-mid';
    if(s>=45) return 'score-low';
    return 'score-dim';
}

// c1~c4 already normalized 0-100, just clamp
function normBar(val){ return Math.min(Math.max(val||0, 0), 100).toFixed(1); }

function drawSparkline(canvas,pts){
    if(!canvas||!pts||pts.length<2) return;
    const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const vals=pts.map(d=>typeof d==='object'?d.p:+d);
    const mn=Math.min(...vals), mx=Math.max(...vals), rng=mx-mn||0.01;
    ctx.beginPath();
    ctx.strokeStyle='rgba(148,163,184,0.5)';  /* slate, not blue */
    ctx.lineWidth=1.5; ctx.lineJoin='round';
    vals.forEach((v,i)=>{
        const x=(i/(vals.length-1))*W, y=H-((v-mn)/rng)*(H-2)-1;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function renderSpotlight(data){
    const top=[...data]
        .filter(d=>d.market_state.includes('High Confidence'))
        .sort((a,b)=>b.nexus_score-a.nexus_score)
        .slice(0,3);
    const grid=document.getElementById('spotlight-grid');
    if(!top.length){grid.innerHTML='<div class="hero-empty">NO HIGH CONFIDENCE EVENTS AT THIS TIME</div>';return;}
    grid.innerHTML=top.map(d=>{
        const lp=normBar(d.c1), ep=normBar(d.c2);
        const ip=normBar(d.c3), cp=normBar(d.c4);
        return `<div class="spotlight-card">
            <div class="spotlight-vol">${fmtVol(d.volume||0)}</div>
            <div class="spotlight-score">${d.nexus_score}</div>
            <div class="spotlight-title">${d.question}</div>
            <div class="spotlight-cat">${d.category||''}</div>
            <div class="spotlight-bars">
                <div class="sp-bar-row"><span class="sp-bar-key">LIQ</span><div class="sp-bar-bg"><div class="sp-bar-fill bar-liq" style="width:${lp}%"></div></div><span class="sp-bar-val">${(+lp).toFixed(0)}</span></div>
                <div class="sp-bar-row"><span class="sp-bar-key">EFF</span><div class="sp-bar-bg"><div class="sp-bar-fill bar-eff" style="width:${ep}%"></div></div><span class="sp-bar-val">${(+ep).toFixed(0)}</span></div>
                <div class="sp-bar-row"><span class="sp-bar-key">IND</span><div class="sp-bar-bg"><div class="sp-bar-fill bar-ind" style="width:${ip}%"></div></div><span class="sp-bar-val">${(+ip).toFixed(0)}</span></div>
                <div class="sp-bar-row"><span class="sp-bar-key">CNV</span><div class="sp-bar-bg"><div class="sp-bar-fill bar-conv" style="width:${cp}%"></div></div><span class="sp-bar-val">${(+cp).toFixed(0)}</span></div>
            </div>
        </div>`;
    }).join('');
}

function renderKPIs(data){
    const total=data.length;
    const highConf=data.filter(d=>d.market_state.includes('High Confidence')).length;
    const active=data.filter(d=>d.market_state.includes('Active')).length;
    const idx=(highConf+active*0.5)/total*100;
    animateCount(document.getElementById('integrity-index'),idx,1);
    document.getElementById('integrity-grade').textContent=idx>=80?'INSTITUTIONAL GRADE':idx>=60?'STRUCTURED':'FRAGMENTED';
    document.getElementById('market-regime').textContent=idx>=70?'STABLE':idx>=45?'TRANSITIONAL':'STRESSED';
    animateCount(document.getElementById('high-conf-count'),highConf,0,700);
    animateCount(document.getElementById('total-markets'),total,0,700);
    document.getElementById('last-update').textContent=
        new Date().toISOString().replace('T',' ').slice(0,19)+' UTC';
}

function renderStateChart(data){
    const counts={};
    data.forEach(d=>{const s=stateInfo(d.market_state).label; counts[s]=(counts[s]||0)+1;});
    /* Monochrome slate palette */
    const colorMap={
        'CITABLE':      'rgba(226,232,240,0.85)',
        'ACTIVE':       'rgba(148,163,184,0.65)',
        'MACRO-DRIVEN': 'rgba(100,116,139,0.5)',
        'VOLATILE':     'rgba(71,85,105,0.45)',
        'SPARSE DATA':  'rgba(30,41,59,0.7)',
    };
    const labels=Object.keys(counts);
    const ctx=document.getElementById('stateChart').getContext('2d');
    if(stateInst) stateInst.destroy();
    stateInst=new Chart(ctx,{
        type:'doughnut',
        data:{labels,datasets:[{data:Object.values(counts),backgroundColor:labels.map(l=>colorMap[l]||'rgba(30,41,59,0.5)'),borderWidth:0,hoverOffset:4}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{
            legend:{position:'right',labels:{color:'#64748b',font:{family:"'JetBrains Mono',monospace",size:9},boxWidth:8,padding:10}},
            tooltip:{backgroundColor:'#161f2c',borderColor:'#1e293b',borderWidth:1,
                titleColor:'#e2e8f0',bodyColor:'#94a3b8',
                titleFont:{family:"'JetBrains Mono',monospace",size:10},
                bodyFont:{family:"'JetBrains Mono',monospace",size:10}}
        }}
    });
}

function renderRadarChart(data){
    const n = data.length || 1;
    const sums = data.reduce((a,d)=>({
        c1: a.c1+(d.c1||0),
        c2: a.c2+(d.c2||0),
        c3: a.c3+(d.c3||0),
        c4: a.c4+(d.c4||0)
    }), {c1:0,c2:0,c3:0,c4:0});
    // already 0-100, just average
    const vals = [sums.c1/n, sums.c2/n, sums.c3/n, sums.c4/n];
    const ctx=document.getElementById('radarChart').getContext('2d');
    if(radarInst) radarInst.destroy();
    radarInst=new Chart(ctx,{
        type:'radar',
        data:{labels:['LIQUIDITY','EFFICIENCY','INDEPENDENCE','CONVERGENCE'],datasets:[{data:vals,
            backgroundColor:'rgba(59,130,246,0.07)',
            borderColor:'rgba(59,130,246,0.35)',
            pointBackgroundColor:'rgba(96,165,250,0.6)',
            pointBorderColor:'transparent',
            pointRadius:3, borderWidth:1.5}]},
        options:{responsive:true,maintainAspectRatio:false,
            scales:{r:{min:0,max:100,ticks:{display:false},
                grid:{color:'#1e293b'},angleLines:{color:'#1e293b'},
                pointLabels:{color:'#64748b',font:{family:"'JetBrains Mono',monospace",size:9}}}},
            plugins:{legend:{display:false},
                tooltip:{backgroundColor:'#161f2c',borderColor:'#1e293b',borderWidth:1,
                    titleColor:'#e2e8f0',bodyColor:'#94a3b8',
                    titleFont:{family:"'JetBrains Mono',monospace",size:10},
                    bodyFont:{family:"'JetBrains Mono',monospace",size:10},
                    callbacks:{label:c=>` ${c.formattedValue}%`}}}}
    });
}

function renderTable(data){
    const sorted=[...data].sort((a,b)=>{
        const r=s=>s.includes('High Confidence')?3:s.includes('Active')?2:1;
        return r(b.market_state)-r(a.market_state)||b.nexus_score-a.nexus_score;
    }).slice(0,15);

    document.getElementById('table-body-wrap').innerHTML=`<table>
        <thead><tr>
            <th>MARKET QUESTION</th><th>NEXUS SCORE</th><th>DATA STATE</th>
            <th style="min-width:165px">INTEGRITY BREAKDOWN</th>
            <th style="min-width:90px">MACRO BETA</th><th>VOLUME</th><th>TREND</th><th></th>
        </tr></thead>
        <tbody id="market-tbody"></tbody>
    </table>`;

    const tbody=document.getElementById('market-tbody');
    sorted.forEach((row,i)=>{
        const si=stateInfo(row.market_state), spId=`sp-${i}`;
        const lp=normBar(row.c1), ep=normBar(row.c2);
        const ip=normBar(row.c3), cp=normBar(row.c4);
        const tr=document.createElement('tr');
        if(si.rowCls) tr.className=si.rowCls;
        tr.innerHTML=`
            <td><div class="event-title" title="${row.question}">${row.question}</div><div class="event-cat">${row.category||''}</div></td>
            <td><span class="score-cell ${scoreClass(row.nexus_score)}">${row.nexus_score}</span></td>
            <td><span class="badge ${si.cls}">${si.label}</span></td>
            <td><div class="subscores">
                <div class="subscore-row"><span class="subscore-key">LIQ</span><div class="bar-bg"><div class="bar-fill bar-liq" style="width:${lp}%"></div></div><span class="subscore-val">${(+lp).toFixed(0)}</span></div>
                <div class="subscore-row"><span class="subscore-key">EFF</span><div class="bar-bg"><div class="bar-fill bar-eff" style="width:${ep}%"></div></div><span class="subscore-val">${(+ep).toFixed(0)}</span></div>
                <div class="subscore-row"><span class="subscore-key">IND</span><div class="bar-bg"><div class="bar-fill bar-ind" style="width:${ip}%"></div></div><span class="subscore-val">${(+ip).toFixed(0)}</span></div>
                <div class="subscore-row"><span class="subscore-key">CNV</span><div class="bar-bg"><div class="bar-fill bar-conv" style="width:${cp}%"></div></div><span class="subscore-val">${(+cp).toFixed(0)}</span></div>
            </div></td>
            <td class="macro-cell">${(row.macro_sensitivity||0).toFixed(2)}</td>
            <td class="vol-cell">${fmtVol(row.volume||0)}</td>
            <td><canvas id="${spId}" class="sparkline-canvas" width="80" height="26"></canvas></td>
            <td><a class="link-btn" href="https://polymarket.com/event/${row.slug||row.id||''}" target="_blank">VIEW →</a></td>
        `;
        tbody.appendChild(tr);
        if(row.sparkline) requestAnimationFrame(()=>drawSparkline(document.getElementById(spId),row.sparkline));
    });
}

async function init(){
    let data=null;
    try{
        const r=await fetch(DATA_URL);
        if(!r.ok) throw new Error();
        const raw=await r.json();
        if(Array.isArray(raw)&&raw.length) data=raw;
    }catch(_){}
    if(!data) data=MOCK;
    renderSpotlight(data); renderKPIs(data);
    renderStateChart(data); renderRadarChart(data); renderTable(data);
}

init();
setInterval(init, 5*60*1000);
</script>
</body>
</html>